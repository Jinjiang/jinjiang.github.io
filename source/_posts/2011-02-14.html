---
title: "Web版的俄罗斯方块"
date: 2011/2/14 14:02
updated: 2011/2/14 14:02
---

<p><mark>本文摘自 勾三股四 更早时期的 <a href="http://bulaoge.net/?g3g4">不老歌</a> 博客。</mark></p>
<p>更新：<br />刚才发现每个方块刚出现在最上面时或旋转的时候，会有“漂移”的现象，看来我的算法还是设计得不够好：（<hr />
这次的主要把重心放在了数据结构和逻辑层面，界面相对做的比较粗糙。<br />另外教材就不多写了，源码在这里：<a href="https://github.com/Jinjiang/Tetris" target="_blank">https://github.com/Jinjiang/Tetris</a><br />
和那颗<a href="http://bulaoge.net/topic.blg?tuid=27015&tid=1968094" target="_blank">用 CSS 3 做的大红心</a>同样，如果你是通过订阅或人人日志、开心日志或微博等不靠谱平台看到的，可能效果不正，有劳移步至此欣赏：<a href="http://bulaoge.net/topic.blg?tuid=27015&tid=1970594" target="_blank">http://bulaoge.net/topic.blg?tuid=27015&tid=1970594</a><hr />
<style>#field{line-height:16px;letter-spacing:0px;font-size:24px;margin:0;padding:5px;float:left;width:160px;border-style:none;background:white;}#next{line-height:16px;letter-spacing:0px;font-size:24px;margin:0;padding:5px;float:left;width:80px;border-style:none;background:white;}</style>
<!--[if IE]><style>#field,#next{letter-spacing:0;line-height:14px;}</style><![endif]-->
<p>Your Score: <span id="score"></span></p>
<pre id="field"></pre>
<pre id="next"></pre>
<script>function Cell(a,b){a=parseInt(a||0);b=parseInt(b||0);this.getX=function(){return a};this.setX=function(c){a=parseInt(c||0)};this.getY=function(){return b};this.setY=function(c){b=parseInt(c||0)}}function Position(a,b){a=parseInt(a||0);b=parseInt(b||0);this.getX=function(){return a};this.setX=function(c){a=parseInt(c||0)};this.getY=function(){return b};this.setY=function(c){b=parseInt(c||0)};this.left=function(){a--};this.right=function(){a++};this.down=function(){b--};this.previewLeft=function(){return new Position(a-1,b)};this.previewRight=function(){return new Position(a+1,b)};this.previewDown=function(){return new Position(a,b-1)}}function Block(a,c,b){a=parseInt(a||0);c=parseInt(c||0);b=!!b;this.getX=function(){return a};this.setX=function(d){a=parseInt(d||0)};this.getY=function(){return c};this.setY=function(d){c=parseInt(d||0)};this.getDisplay=function(){return b};this.setDisplay=function(d){b=!!d}}function Line(d,b){var a=[];var e;b=parseInt(b||0);for(var c=0;c<d.length;c++){e=new Block(c,b,d[c]);a.push(e)}this.getBlockArray=function(){return a};this.getLineOffset=function(){return b};this.cutLineOffset=function(f){b-=parseInt(f||1);for(var g=0;g<a.length;g++){a[g].setY(b)}};this.getBlockDisplay=function(f){return a[f].getDisplay()};this.setBlockDisplay=function(g,f){return a[g].setDisplay(f)};this.checkFullfilled=function(){for(var f=0;f<a.length;f++){if(!a[f].getDisplay()){return false}}return true}}function Grid(c,a,b){c=parseInt(c||10);a=parseInt(a||20);b=b||[];var j=[];var k;var e;var h;var g;var f;for(var d=0;d<a;d++){e=[];e[c-1]=false;k=new Line(e,d);j.push(k)}for(var d=0;d<b.length;d++){h=showCellArray[d];g=h.getX();f=h.getY();j[f].setBlockDisplay(g,true)}this.getLineArray=function(){return j};this.checkPieceAvailable=function(o,q){var p=o.getShownCellArray();var m;var l;var r;for(var n=0;n<p.length;n++){m=p[n];l=q.getX()+m.getX();r=q.getY()-m.getY();if(r<20&&r>=0&&l<10&&l>=0){if(j[r].getBlockDisplay(l)){return false}}else{return false}}return true};this.addPieceAndGetCutLineNumberArray=function(q,m){var l=q.getShownCellArray();var t;var s;var r;var u=0;var n=[];var v;var p;for(var o=0;o<l.length;o++){t=l[o];s=m.getX()+t.getX();r=m.getY()-t.getY();if(r<20&&r>=0&&s<10&&s>=0){j[r].setBlockDisplay(s,true)}}for(var o=0;o<a;o++){v=j[o];if(u>0){v.cutLineOffset(u)}if(v.checkFullfilled()){n.push(o+u);u++;j.splice(o,1);o--;p=[];p[c-1]=false;v=new Line(p,o);j.push(v)}}return n}}function Piece(b,g){var a={O:{size:2,shownCellArray:[new Cell(1,1),new Cell(1,0),new Cell(0,1),new Cell(0,0)]},J:{size:3,shownCellArray:[new Cell(1,0),new Cell(1,1),new Cell(1,2),new Cell(0,2)]},L:{size:3,shownCellArray:[new Cell(1,0),new Cell(1,1),new Cell(1,2),new Cell(2,2)]},T:{size:3,shownCellArray:[new Cell(0,1),new Cell(1,1),new Cell(1,0),new Cell(2,1)]},S:{size:3,shownCellArray:[new Cell(0,1),new Cell(1,1),new Cell(1,2),new Cell(2,2)]},Z:{size:3,shownCellArray:[new Cell(1,0),new Cell(1,1),new Cell(2,1),new Cell(2,2)]},I:{size:4,shownCellArray:[new Cell(0,0),new Cell(0,1),new Cell(0,2),new Cell(0,3)]}};if(!b||!a[b]){b=["O","J","L","T","S","Z","I"][Math.floor(Math.random()*7)]}if(typeof g=="number"){g=parseInt(g)}else{g=Math.floor(Math.random()*4)}var f=a[b].shownCellArray;var e=a[b].size;var h=0;function c(l){var k;var j;var o;var n;if(l){n=[];for(var m=0;m<f.length;m++){k=f[m];j=k.getX();o=k.getY();k=new Cell(j,o);n.push(k)}}else{n=f}for(var m=0;m<n.length;m++){k=n[m];j=k.getX();o=k.getY();if({I:1,O:1}[b]){k.setX(o);k.setY(j)}else{if(h==1){if(b=="S"){j++}if(b=="Z"){o--}}k.setX(2-o);k.setY(j)}}h++;if(h>=4){h-=4}return{getShownCellArray:function(){return n}}}for(var d=0;d<g;d++){c()}this.getShownCellArray=function(){return f};this.getType=function(){return b+h};this.rotate=function(i){c();if(!!i){c();c()}};this.previewTurn=function(j){var i;i=c(true);if(!!j){c(true);i=c(true)}return i}}function Change(c){var a=false;var b=0;if(c){a=!!c.gridChanged;b=c.scoreChanged||[]}this.checkGridChanged=function(){return a};this.checkScoreChanged=function(){return b}}function Field(c,g){c=parseInt(c||10);g=parseInt(g||20);var a=new Grid(c,g);var f=0;var e=new Piece();var d=new Position(Math.floor(c/2-2),g-1);var b=new Piece();this.getGrid=function(){return a};this.getScore=function(){return f};this.getCurrent=function(){return e};this.getCurrentPosition=function(){return d};this.getNext=function(){return b};this.down=function(){var h;var i;h=!a.checkPieceAvailable(e,d.previewDown());if(h){i=a.addPieceAndGetCutLineNumberArray(e,d);f+=i.length;e=b;b=new Piece();d=new Position(Math.floor(c/2-2),g-1)}else{d.down()}return(new Change({gridChanged:h,scoreChanged:i}))};this.left=function(){var h=a.checkPieceAvailable(e,d.previewLeft());if(h){d.left()}return h};this.right=function(){var h=a.checkPieceAvailable(e,d.previewRight());if(h){d.right()}return h};this.rotate=function(h){var i=a.checkPieceAvailable(e.previewTurn(h),d);if(i){e.rotate(h)}return i}}var field=new Field();function drawField(){var a=field.getGrid();var o=a.getLineArray();var b=[];for(var g=19;g>=0;g--){var p=o[g];var n=p.getBlockArray();for(var f=0;f<n.length;f++){var e=n[f];if(e.getDisplay()){b.push("■")}else{b.push("□")}}b.push("<br />")}var k=field.getCurrent();var d=field.getCurrentPosition();var c=k.getShownCellArray();var m;var l;var h;for(var g=0;g<c.length;g++){cell=c[g];m=cell.getX()+d.getX();l=-cell.getY()+d.getY();h=(19-l)*11+m;b[h]="■"}b=b.join("");document.getElementById("field").innerHTML=b}function drawNext(){var a=["□","□","□","□","<br />","□","□","□","□","<br />","□","□","□","□","<br />","□","□","□","□","<br />"];var e=field.getNext();var b=e.getShownCellArray();var k;var j;var g;var h=e.getType();var f="L2 J0 T3 S1 S3 I0 I2 O0 O1 O2 O3".match(h)?1:0;var d="L1 J3 T2 Z1 Z3 S0 S2 I0 I2".match(h)?0:1;for(var c=0;c<b.length;c++){cell=b[c];k=cell.getX()+f;j=cell.getY()+d;g=j*5+k;a[g]="■"}a=a.join("");document.getElementById("next").innerHTML=a}function updateScore(){document.getElementById("score").innerHTML=field.getScore()}function down(){var a=field.down();if(a&&a.checkGridChanged()){drawNext();if(a.checkScoreChanged().length>0){if(window.console){window.console.log("GOT "+a.checkScoreChanged().length+" POINTS!")}updateScore();drawField()}}else{drawField()}}function left(){if(field.left()){drawField()}}function right(){if(field.right()){drawField()}}function rotate(a){if(field.rotate(a)){drawField()}}drawField();drawNext();updateScore();document.onkeydown=function(a){a=a||window.event;switch(a.keyCode){case 13:rotate(true);if(a.preventDefault){a.preventDefault()}break;case 37:left();if(a.preventDefault){a.preventDefault()}break;case 38:rotate();if(a.preventDefault){a.preventDefault()}break;case 39:right();if(a.preventDefault){a.preventDefault()}break;case 40:down();if(a.preventDefault){a.preventDefault()}break;default:}};window.setInterval(down,1000);</script></p>
